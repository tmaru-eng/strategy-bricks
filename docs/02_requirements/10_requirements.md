# 要件定義書（Requirements）— Strategy Bricks（仮称）

## 0. ドキュメント情報
- 版：v0.1（検討内容の網羅版）
- 対象：実装担当（AIエージェント含む）／レビュー担当
- 目的：作るべきもの（WHAT）と制約、受入条件を明確化する

---

## 1. 目的・成功条件

### 1.1 目的
- ブロック（判定・計算）をGUIで組み合わせて戦略を構築し、MT5 EAが設定を読み込んで実行する。

### 1.2 成功条件（Definition of Done：要件レベル）
- GUIで作成した `active.json` をEAが読み込み、意図した条件構成で売買できる。
- 判定は基本確定足で行われ、同一足で再エントリーしない。
- ブロック判定の理由（reason）がログに残り、検証・改善ができる。
- ブロック追加・変更が局所的で、メンテが容易（疎結合）。

---

## 2. 対象範囲（Scope）

### 2.1 対象（In Scope）
- MT5（MQL5）EA Runtime
- Electron Strategy Builder（マルチプラットフォーム）
- 独自設定ファイル（JSON）：`strategy_config.json`（運用は `active.json` を推奨）
- ブロック合成（OR枠 × AND内）
- M1のみでトレンド・押し目・トリガー判定
- ナンピンモード（平均建値改善、平均建値決済、損切りを含む）

### 2.2 非対象（Out of Scope：初期）
- 外部ニュースAPI連携（設計余地は残す）
- 高度な機械学習モデル
- MT4対応

---

## 3. 用語定義（Glossary）
- Block：判定／計算部品。副作用なし。
- Action：発注／決済／変更など副作用を伴う処理。
- Strategy：複数のRuleGroup（OR）を含む取引ルールセット。ロット／リスク／決済／ナンピンを持つ。
- EntryRequirement：エントリー条件の合成ルート（OR/AND）。
- RuleGroup：条件のAND集合（全条件がPASSで成立）。
- 確定足（Closed bar）：基本的に shift=1 のバーを参照する運用。

---

## 4. 機能要件（Functional Requirements）

## 4.1 Strategy Builder（Electron）

### FR-GUI-01：ブロックカタログ表示
- `block_catalog.json` を読み込み、カテゴリ別にブロックを表示できる。

### FR-GUI-02：戦略の構築（ノード／ブロック）
- ユーザーはブロックを配置し、戦略を構成できる。
- ルール構造は以下を基本形として強制できる（UI制約）。
  - EntryRequirement = OR（RuleGroup…）
  - RuleGroup = AND（ConditionBlock…）

### FR-GUI-03：パラメータ編集
- 各ブロックのパラメータを編集できる（paramsSchemaに基づくフォーム生成）。

### FR-GUI-04：バリデーション
- Export前に以下を検出し、ユーザーに提示する。
  - 必須パラメータ未設定
  - 型不整合・範囲外
  - 参照切れ（存在しないブロックID参照）
  - 循環参照（将来拡張で必要なら）

### FR-GUI-05：設定ファイル出力
- `profiles/<name>.json` と `active.json` を出力できる。
- 出力先フォルダは設定可能（MT5の `MQL5/Files/strategy/` を想定）。

---

## 4.2 EA Runtime（MT5 / MQL5）

### FR-EA-01：設定ファイル読込
- `active.json`（または指定ファイル）を読み込み、Strategy/Block構成を復元できる。
- `formatVersion` を確認し、非互換の場合は実行停止し理由をログする。

### FR-EA-02：実行タイミング
- エントリー評価は **M1新バー時のみ**実行する。
- ポジション管理は以下のいずれか（設計で選定、MVPではどちらでも良いが明記する）。
  - 方針A：毎Tickで実行（トレール等が滑らか）
  - 方針B：新バーのみ実行（挙動が単純で再現性が高い）

### FR-EA-03：確定足運用
- 判定（フィルタ、トレンド、トリガー）は原則 **確定足（shift=1）**データを参照する。

### FR-EA-04：同一足再エントリー禁止
- 同一M1バー内で複数回エントリーしない。
- 二重ガードを持つこと。
  - 新バーでのみ評価
  - `lastEntryBarTime` 等で同一バー時刻の発注を拒否

### FR-EA-05：ポジション制限と挙動
- 最大ポジション数（シンボル別／総数等）を設定できる。
- 制限超過時は **新規エントリーを停止**し、**ポジション管理のみ**実施する。

### FR-EA-06：Strategy評価
- Strategyを複数保持し、priority順に評価できる。
- MVPの採用ルール：**firstOnly（最初に成立したStrategyのみ採用）**
- 条件合成：OR（RuleGroup）× AND（Conditions）を短絡評価できる。

### FR-EA-07：ブロック評価
- ブロックは `Evaluate(ctx) -> BlockResult` を満たす。
- BlockResultは以下を含む。
  - PASS/FAIL/NEUTRAL
  - （必要に応じて）方向（LONG/SHORT/NEUTRAL）
  - reason（文字列）
  - （将来）score

### FR-EA-08：ロットモデル
- 少なくとも固定ロットは必須。
- 拡張として以下を選択可能にする（段階導入可）。
  - 資金割合
  - SL距離からの損失割合
  - モンテカルロ
  - マーチン等

### FR-EA-09：リスク（SL/TP）設定
- SL/TPを設定可能（固定/変動などは拡張）。
- EA側の実装はブローカー制約（最小ロット、step、ストップレベル等）を考慮し、失敗時の理由をログする。

### FR-EA-10：ポジション管理
- 代表例（優先度は設計で定義、MVPは一部でも可）：
  - トレーリング
  - 建値（BreakEven）
  - 平均建値決済（ポジション数増えすぎた場合）
  - 平均利益決済
  - 週末決済／平日決済（時間指定）
  - 反対シグナルでクローズ（任意）

### FR-EA-11：ナンピン（モード）
- ナンピンを許可/禁止（グローバル／Strategy単位は設計で決定）
- 追加条件（例：逆行幅、ATR倍率、段数制限）
- 最大段数到達時の挙動（例：平均建値近辺で決済）
- 損切り（シリーズ損切り）を提供する（価格/時間/DD等は拡張）

### FR-EA-12：ログ（原因追跡）
- 最低限、以下をログに残す。
  - Strategy評価結果（採用/不採用、理由）
  - RuleGroup成立/不成立、主要ブロックのreason
  - 発注成功/失敗、失敗理由
  - 管理アクション発動（建値、平均建値決済、ナンピン等）と理由

---

## 5. 非機能要件（Non-Functional Requirements）

### NFR-01：メンテナンス性
- ブロック追加は原則として「新ブロック実装＋catalog追記＋テスト」で完結すること。
- ブロックは副作用禁止（発注・決済はExecutorに集約）。

### NFR-02：性能
- インジケータ取得はハンドル共有等のキャッシュ設計（IndicatorCache）を採用し、計算重複を抑える。

### NFR-03：観測性
- “なぜ入った／入らなかった” を説明できるログ構造を持つ。

### NFR-04：再現性
- エントリー判断は新バー＆確定足に固定し、バックテストとフォワード差を抑える。

---

## 6. 制約（Constraints）
- 対象はMT5（MQL5）。
- 基本はM1のみで判断（上位足は原則不使用）。
- 判定は確定足（shift=1）を基本とする。
- 同一足で再エントリーしない。

---

## 7. 受入条件（Acceptance Criteria）

### AC-01：確定足・新バー運用
- エントリー評価はM1新バー時に1回だけ行われること。
- 判定に未確定足（shift=0）が混入しないこと（原則）。

### AC-02：同一足再エントリー禁止
- 同一M1バー内で複数エントリーが発生しないこと（ログで確認可能）。

### AC-03：OR×ANDルール
- OR（RuleGroupのいずれか成立）× AND（条件全成立）で動作すること。
- 短絡評価され、成立したRuleGroupがログで分かること。

### AC-04：制限超過時の挙動
- ポジション制限超過時、エントリーは停止し管理のみ実行されること。

### AC-05：設定バリデーション
- GUIが参照切れ・必須欠落を検出し、Exportを抑止できること。
- EAはformatVersion非互換を検出して停止し、理由をログすること。

### AC-06：ログ
- ブロック判定理由、採用Strategy、発注失敗理由が確認できること。

---

## 8. 付録：全体像の図（要件視点）
~~~mermaid
flowchart TB
  GUI[GUIでブロック合成] --> CFG[active.json生成]
  CFG --> EA[EAが読み込み]
  EA --> G1[相場環境/制限チェック]
  G1 -->|OK| S[Strategy評価（priority）]
  S --> R[OR（RuleGroup）× AND（Conditions）]
  R -->|成立| O[発注（同一足禁止）]
  R -->|不成立| N[見送り]
  EA --> PM[制限超過時は管理のみ]
~~~

---