# 企画資料（Project Brief）— Strategy Bricks（仮称）

## 0. ドキュメント情報
- 版：v0.1（検討内容の集約版）
- 対象：企画・協力者・実装担当（AIエージェント含む）
- ゴール：本プロジェクトの狙い、提供価値、範囲、全体像を短時間で共有可能にする

---

## 1. プロジェクト概要

### 1.1 仮称
- Strategy Bricks（変更可）

### 1.2 何を作るか（要約）
- **Electron（マルチプラットフォーム）で動くノード／ブロック型 Strategy Builder** と、
- **MT5（MQL5）で動くEA Runtime** を作る。
- ユーザーは Builder 上で **ブロック（判定・計算）**を組み合わせて戦略（複数）を作成し、
  出力された **strategy_config.json（独自設定ファイル）**をEAが読み込んで実行する。

### 1.3 主要コンセプト（レゴ的構造）
- 条件は「レゴブロック」のように **差し替え可能／疎結合**。
- ルール構造は基本形として **枠がOR、ルール内がAND**（DNF形式）。
  - 「条件セット（AND）が複数（OR）あり、どれか成立したらエントリー候補」

---

## 2. 背景・課題

### 2.1 背景
- M1（1分足）で主要トレンドに対して押し目で入る戦略は、局面により負けやすい。
- 単一ロジックでは相場環境変化に弱く、複数戦略・複数フィルタの組み合わせが必要。

### 2.2 課題
- 条件追加や微調整が「コードの改修」になりがちで保守コストが高い。
- 条件を増やすほど分岐が増え、検証や事故原因追跡（なぜエントリーした／しなかった）が難しい。
- インジケータ／状態（ナンピン段数、クールダウンなど）／発注が密結合すると拡張が困難。

---

## 3. 提供価値（Value Proposition）

### 3.1 ユーザー価値
- ブロックをGUIで組むだけで、戦略の構成変更が可能（実装の属人化を低減）。
- 戦略のテンプレート化・再利用が容易（Strategy Set を管理可能）。
- 各ブロックの判定理由（reason）をログ化し、検証や改善が回しやすい。

### 3.2 開発・保守価値
- 変更が「ブロック単位」に閉じる（影響範囲が小さい）。
- AIエージェントに分担実装させやすい（契約＝JSONスキーマ＋I/Fが中心）。
- ランタイムの責務分離により、機能追加（フィルタ追加、トリガー追加、ロットモデル追加）が容易。

---

## 4. 対象・前提

### 4.1 対象プラットフォーム
- EA：MT5（MQL5）
- Builder：Electron（Windows/macOS/Linux）

### 4.2 取引・判定の基本方針（重要）
- **基本は確定足（closed bar）で判定**
- **同一足での再エントリーは行わない**
- 相場判断は基本 **M1のみ**（上位足を原則使わない）

---

## 5. 機能の全体像（コンポーネント）

### 5.1 全体アーキテクチャ図
~~~mermaid
flowchart LR
  GUI[Electron Strategy Builder] -->|読み込み| CAT[block_catalog.json<br/>（ブロック定義）]
  GUI -->|生成| CFG[strategy_config.json / active.json<br/>（戦略定義）]
  CFG -->|読み込み| EA[MT5 EA Runtime（MQL5）]
  EA -->|発注/決済/変更| MKT[Broker/Market]
  EA -->|ログ| LOG[Logs（原因追跡）]
~~~

### 5.2 Builder（GUI）の役割
- ブロックパレット（カタログ）からドラッグ＆ドロップ
- 条件をOR/ANDで合成してStrategyを複数作成
- パラメータ入力（paramsSchemaからフォーム生成）
- バリデーション（参照切れ、必須未設定、型・範囲、循環など）
- Export（profiles保存＋active.json更新）

### 5.3 EA Runtime（MT5）の役割
- 設定ファイルをロードし、Strategyを優先度順に評価
- ブロック評価は副作用なし、注文はExecutorに集約
- ポジション制限超過時は **エントリー停止して管理のみ**
- ナンピン（平均建値改善）をモードとして提供（損切り含む）

---

## 6. ルール構造（OR枠 × AND内）

### 6.1 ルール構造の図解（DNF）
~~~mermaid
flowchart TB
  ER[EntryRequirement（OR）] --> RG1[RuleGroup#1（AND）]
  ER --> RG2[RuleGroup#2（AND）]
  RG1 --> C11[Filter条件]
  RG1 --> C12[Trend条件]
  RG1 --> C13[Trigger条件]
  RG2 --> C21[Filter条件]
  RG2 --> C22[Trend条件]
  RG2 --> C23[Trigger条件]
~~~

### 6.2 実務的な解釈
- RuleGroup（AND）：そのルール内の条件を **全て満たした時のみ**成立
- EntryRequirement（OR）：RuleGroupのうち **どれか1つ成立**すればエントリー候補

---

## 7. 実行フロー（EA Orchestrator）

### 7.1 フロー要約（検討内容に基づく）
1. 相場環境の確認
2. エントリーポジションの確認
3. ポジション制限数確認
4. エントリー条件確認（複数Strategyを評価）
   - フィルタ（Spread/Session/Volatility/News等）
   - トレンド判定（M1のみ）
   - トリガー条件
   - ロット計算（固定/変動/モンテカルロ/マーチン等）
   - エントリー
5. 必要に応じて次Strategyへ
6. ナンピン許可ならナンピンロジック評価
7. 制限超過時は「管理のみ」へ

### 7.2 フロー図（概念）
~~~mermaid
flowchart TB
  T([Tick]) --> NB{NewBar M1?}
  NB --No--> PM[管理（任意：毎Tick）]
  NB --Yes--> ENV[相場環境/制限チェック]
  ENV --> LIM{制限超過？}
  LIM --Yes--> M[管理のみ]
  LIM --No--> S[[Strategyを優先度順に評価]]
  S --> E{RuleGroup成立？}
  E --Yes--> O[発注（同一足再エントリー禁止）]
  E --No--> N[[次Strategyへ]]
  O --> A[ナンピン評価（許可時）]
  N --> A
  A --> END([次へ])
~~~

---

## 8. 重要な差別化（メンテナンス性）

### 8.1 メンテ性の核心
- **ブロック＝判定・計算部品（副作用なし）**
- **副作用（発注/決済/変更）はExecutor/Managerに集約**
- **IndicatorCacheでインジケータ取得を集中管理**（性能・一貫性）

### 8.2 AIエージェントが扱いやすい境界
- 契約：`strategy_config.json` と `block_catalog.json` と `IBlock` の評価I/F
- 実装：ブロック追加は「新Block + catalog追記 + テスト」で完結

---

## 9. スコープ（企画レベル）

### 9.1 MVP（最小実用）
- Builder：ブロック配置、OR/AND合成、パラメータ入力、Validate、Export
- EA：設定読み込み、OR/AND評価、確定足、同一足再エントリー禁止、基本発注
- ブロック：Filter（Spread/Session）、Trend（簡易）、Trigger（簡易）、Lot（固定）
- 管理：最低限（SL/TP、ログ、制限超過時は管理のみ）

### 9.2 拡張（段階的に追加）
- 多様なトレンド判定（EMA/ADX/Structure等）
- 多様なトリガー（pullback/reversal/breakout等）
- ロットモデル（資金割合/SLベース/モンテカルロ/マーチン）
- ナンピンモード（安全装置込み）を高度化
- テンプレ戦略セット（一般的戦略を可能な限り収録）

---

## 10. リスクと対策（企画段階）

- リスク：過最適化 → 対策：テンプレと検証手順、ログ、受入基準を明確化
- リスク：計算負荷増 → 対策：IndicatorCache、確定足評価で頻度制御
- リスク：運用事故（連打/ナンピン暴走） → 対策：ガード（最大ポジ/総ロット/スプレッド停止/クールダウン/シリーズ損切り）

---

## 11. 成果物（アウトプット）
- Electron Strategy Builder（アプリ）
- MT5 EA Runtime（MQL5）
- block_catalog.json（ブロック定義）
- strategy_config.json / active.json（実行設定）
- テンプレ戦略セット（複数）
- 企画・要件・設計・運用ドキュメント一式

---