# 実装計画: GUIバックテスト統合

## 概要

この実装計画は、Strategy Bricks GUIビルダーにバックテスト機能を追加します。実装は、フロントエンドUI、Electronメインプロセス、Pythonバックテストエンジンの3つの主要コンポーネントに分かれています。各タスクは前のタスクの上に構築され、段階的な進捗と早期の検証を可能にします。

## タスク

- [x] 1. 設定ファイルインターフェースの定義とプロジェクト構造のセットアップ
  - [x] 1.1 統一設定ファイルフォーマットを定義
    - GUIとEA（MQL5）の両方で使用可能なJSON設定スキーマを設計
    - ストラテジーブロック、パラメータ、メタデータの構造を定義
    - 設定スキーマのドキュメントを作成（`ea/tests/CONFIG_SCHEMA.md`）
    - 将来のEA連携で再修正が不要な拡張可能な設計を確保
    - _要件: 2.1, 5.1_
  
  - [x] 1.2 プロジェクト構造を作成
    - Pythonバックテストエンジン用のディレクトリ構造を作成（`python/backtest_engine.py`）
    - TypeScript型定義を作成（`BacktestConfig`, `BacktestResults`, `Trade`, `StrategyConfig`インターフェース）
    - プロパティベーステストライブラリをインストール（fast-check for TypeScript, Hypothesis for Python）
    - _要件: 1.1, 2.1, 6.1_

- [x] 2. バックテスト設定ダイアログの実装
  - [x] 2.1 BacktestConfigDialogコンポーネントを作成
    - シンボル、時間軸、日付範囲の入力フィールドを実装
    - デフォルト値を設定（USDJPY, M1, 過去3ヶ月）
    - ローカルストレージへの設定永続化を実装
    - _要件: 1.1, 1.2, 1.5_
  
  - [x] 2.2 設定検証ロジックを実装
    - `validateBacktestConfig`関数を作成
    - 空のシンボル、無効な日付範囲、未来の日付をチェック
    - 検証エラーメッセージを表示
    - _要件: 1.4_
  
  - [ ]* 2.3 設定検証のプロパティテストを作成
    - **プロパティ2: 有効なパラメータの受け入れ**
    - **プロパティ3: 無効なパラメータの拒否**
    - **検証: 要件 1.3, 1.4**
  
  - [ ]* 2.4 設定永続化のプロパティテストを作成
    - **プロパティ1: 設定のラウンドトリップ一貫性**
    - **検証: 要件 1.5**

- [ ] 3. ストラテジー設定エクスポート機能の実装
  - [x] 3.1 ストラテジー設定のJSONシリアライゼーションを実装
    - 現在のストラテジー設定をJSONに変換
    - 一意のファイル名を生成（`strategy_<timestamp>.json`）
    - `ea/tests/`ディレクトリに保存
    - _要件: 2.1, 2.2_
  
  - [x] 3.2 設定検証とエラーハンドリングを実装
    - 必須フィールド（strategyName, blocks）をチェック
    - 無効な設定の場合はバックテスト実行を防止
    - _要件: 2.4_
  
  - [ ]* 3.3 ストラテジー設定シリアライゼーションのプロパティテストを作成
    - **プロパティ4: ストラテジー設定のシリアライゼーション**
    - **プロパティ5: ファイルパスの一意性**
    - **検証: 要件 2.1, 2.2**

- [ ] 4. Electron IPCハンドラーとプロセス管理の実装
  - [x] 4.1 IPCコンテキストブリッジを作成
    - `preload.ts`にBacktestAPIを実装
    - `startBacktest`, `cancelBacktest`, イベントリスナーを公開
    - _要件: 3.1_
  
  - [x] 4.2 BacktestProcessManagerクラスを実装
    - Pythonプロセスの起動ロジックを実装
    - コマンドライン引数の構築（config, symbol, timeframe, dates）
    - 標準出力/エラー出力のキャプチャ
    - _要件: 3.1, 3.2_
  
  - [x] 4.3 プロセスタイムアウトとキャンセル機能を実装
    - 5分のタイムアウトを設定
    - キャンセル時のプロセス終了とクリーンアップ
    - _要件: 3.5, 8.3_
  
  - [x] 4.4 エラーハンドリングとロギングを実装
    - プロセス失敗時のエラーキャプチャ
    - ユーザーフレンドリーなエラーメッセージの生成
    - 一時ファイルのクリーンアップ
    - _要件: 3.4, 10.1, 10.2, 10.3_
  
  - [ ]* 4.5 IPCハンドラーのプロパティテストを作成
    - **プロパティ6: プロセス起動の信頼性**
    - **プロパティ7: プロセスタイムアウト**
    - **プロパティ8: エラー条件の適切な処理**
    - **検証: 要件 3.1, 3.2, 3.4, 3.5**
  
  - [ ]* 4.6 リクエストキューイングのプロパティテストを作成
    - **プロパティ19: リクエストのキューイング**
    - **検証: 要件 10.5**

- [ ] 5. チェックポイント - フロントエンドとIPCの統合確認
  - すべてのテストが合格することを確認
  - ユーザーに質問があれば尋ねる

- [ ] 6. Pythonバックテストエンジンのコア実装
  - [x] 6.1 BacktestEngineクラスの基本構造を作成
    - コマンドライン引数の解析（argparse）
    - 初期化メソッドとメインフローを実装
    - _要件: 4.1, 5.1_
  
  - [x] 6.2 MT5ライブラリの初期化と接続を実装
    - `initialize_mt5`メソッドを実装
    - 接続失敗時のエラーハンドリング
    - _要件: 4.1, 4.2_
  
  - [x] 6.3 ストラテジー設定の読み込みと解析を実装
    - `load_strategy_config`メソッドを実装
    - JSONファイルの読み取りと検証
    - 必須フィールドのチェック
    - _要件: 5.1, 5.2_
  
  - [ ]* 6.4 設定解析のプロパティテストを作成
    - **プロパティ4: ストラテジー設定のシリアライゼーション**（Python側）
    - **検証: 要件 5.1, 5.2**

- [ ] 7. 過去データ取得機能の実装
  - [x] 7.1 `fetch_historical_data`メソッドを実装
    - 時間軸マッピング（M1, M5, H1など）
    - MT5からのバーデータ取得
    - データ取得失敗時のエラーハンドリング
    - _要件: 4.3, 4.4_
  
  - [x] 7.2 データ範囲検証を実装
    - 取得したデータが要求された日付範囲をカバーしているか確認
    - 不完全なデータの警告
    - _要件: 4.5_
  
  - [ ]* 7.3 データ範囲検証のプロパティテストを作成
    - **プロパティ9: データ範囲の検証**
    - **検証: 要件 4.5**

- [ ] 8. ストラテジーシミュレーションロジックの実装
  - [x] 8.1 `simulate_strategy`メソッドを実装
    - ストラテジーブロックの解析
    - 過去データの時系列順反復処理
    - エントリー/エグジット条件の評価
    - _要件: 5.3_
  
  - [x] 8.2 エントリー/エグジットシグナルチェックを実装
    - `check_entry_signal`メソッド（簡易版: 移動平均クロスオーバー）
    - `check_exit_signal`メソッド（簡易版: 固定バー数後）
    - _要件: 5.4_
  
  - [x] 8.3 トレード記録と損益計算を実装
    - トレードエントリー/エグジットの記録
    - BUY/SELLポジションの損益計算
    - _要件: 5.4, 5.5_
  
  - [ ]* 8.4 シミュレーションのプロパティテストを作成
    - **プロパティ10: 時系列順の処理**
    - **プロパティ11: トレード記録の完全性**
    - **プロパティ12: 損益計算の正確性**
    - **検証: 要件 5.3, 5.4, 5.5**

- [ ] 9. 結果生成と統計計算の実装
  - [x] 9.1 `generate_results`メソッドを実装
    - 総トレード数、勝ちトレード数、負けトレード数の計算
    - 勝率、総損益、平均トレード損益の計算
    - _要件: 6.1, 6.2_
  
  - [x] 9.2 最大ドローダウン計算を実装
    - `calculate_max_drawdown`メソッドを実装
    - 累積損益曲線からピークとドローダウンを計算
    - _要件: 6.2_
  
  - [x] 9.3 結果のJSONシリアライゼーションと保存を実装
    - メタデータ、サマリー、トレードリストを含む結果オブジェクトを構築
    - JSONファイルに書き込み
    - _要件: 6.3, 6.4, 6.5_
  
  - [ ]* 9.4 統計計算のプロパティテストを作成
    - **プロパティ13: 統計計算の正確性**
    - **プロパティ14: 最大ドローダウン計算**
    - **検証: 要件 6.1, 6.2**
  
  - [ ]* 9.5 結果シリアライゼーションのプロパティテストを作成
    - **プロパティ15: 結果のシリアライゼーション**
    - **プロパティ16: 結果メタデータの完全性**
    - **検証: 要件 6.3, 6.5**

- [ ] 10. チェックポイント - Pythonエンジンの統合確認
  - すべてのテストが合格することを確認
  - ユーザーに質問があれば尋ねる

- [ ] 11. バックテスト結果表示UIの実装
  - [x] 11.1 BacktestResultsViewコンポーネントを作成
    - 結果JSONの解析
    - パフォーマンス指標の表示（総トレード数、勝率、総損益、最大ドローダウン）
    - トレードリストの表示（タイムスタンプ、価格、損益）
    - _要件: 7.1, 7.2, 7.3_
  
  - [x] 11.2 エラー表示とエクスポート機能を実装
    - バックテスト失敗時のエラーメッセージ表示
    - 結果のファイルエクスポート機能
    - _要件: 7.4, 7.5_
  
  - [ ]* 11.3 結果表示のプロパティテストを作成
    - **プロパティ17: 結果表示の完全性**
    - **検証: 要件 7.2, 7.3**

- [ ] 12. 進捗インジケーターとキャンセル機能の実装
  - [x] 12.1 BacktestProgressIndicatorコンポーネントを作成
    - 進捗インジケーターの表示/非表示
    - 経過時間の表示
    - キャンセルボタン
    - _要件: 8.1, 8.2, 8.5_
  
  - [x] 12.2 キャンセル機能を統合
    - キャンセルボタンのクリックハンドラー
    - IPCハンドラーへのキャンセルリクエスト送信
    - _要件: 8.3_
  
  - [ ]* 12.3 キャンセル機能のプロパティテストを作成
    - **プロパティ18: キャンセル時のクリーンアップ**
    - **検証: 要件 8.3**

- [ ] 13. プラットフォーム互換性チェックの実装
  - [x] 13.1 OS検出とMT5ライブラリチェックを実装
    - 起動時のOS検出
    - Python環境とMT5ライブラリの可用性チェック
    - _要件: 9.1, 9.5_
  
  - [x] 13.2 プラットフォーム固有のUI状態を実装
    - Windows + MT5利用可能: バックテスト機能を有効化
    - 非Windows: 機能を無効化し、プラットフォームメッセージを表示
    - MT5未インストール: インストール手順を表示
    - _要件: 9.2, 9.3, 9.4_
  
  - [ ]* 13.3 環境検証のプロパティテストを作成
    - **プロパティ20: 環境検証**
    - **検証: 要件 9.5**
  
  - [ ]* 13.4 プラットフォーム検出の単体テストを作成
    - Windows環境での機能有効化をテスト
    - 非Windows環境での機能無効化をテスト
    - MT5未インストール時のメッセージ表示をテスト
    - _要件: 9.2, 9.3, 9.4_

- [ ] 14. エンドツーエンド統合とエラーハンドリングの完成
  - [x] 14.1 全コンポーネントを統合
    - UI → IPC → Python → 結果 → UIの完全なフローを接続
    - すべてのイベントリスナーとハンドラーを配線
    - _要件: 1.1, 2.1, 3.1, 4.1, 5.1, 6.1, 7.1, 8.1_
  
  - [x] 14.2 包括的なエラーハンドリングを実装
    - すべてのエラーカテゴリ（設定、環境、実行時、解析）を処理
    - エラーロギングとユーザーメッセージを統一
    - _要件: 10.1, 10.2, 10.3, 10.4_
  
  - [ ]* 14.3 エンドツーエンド統合テストを作成
    - 正常なバックテストフローをテスト
    - エラーケース（MT5接続失敗、無効な設定など）をテスト
    - キャンセル機能をテスト
    - _要件: すべて_

- [ ] 15. 最終チェックポイント - すべてのテストが合格することを確認
  - すべての単体テストとプロパティテストを実行
  - 手動でバックテスト機能をテスト（USDJPY M1 3ヶ月）
  - ユーザーに質問があれば尋ねる

## 注意事項

- `*`マークの付いたタスクはオプションであり、より速いMVPのためにスキップできます
- 各タスクは特定の要件を参照してトレーサビリティを確保します
- チェックポイントは段階的な検証を保証します
- プロパティテストは普遍的な正確性プロパティを検証します
- 単体テストは特定の例とエッジケースを検証します
- **重要**: タスク1.1で定義する設定ファイルインターフェースは、GUIとEA（MQL5）の両方で使用されます。将来のEA連携で再修正が不要なように、拡張可能で明確に定義された設計を確保してください。
